# BDH Project Guidelines

## 1. Source of Truth
* Always refer to `project_context.md` for architecture details (Equations, Dimensions).
* **Do not** hallucinate different parameters; stick to the N, D, L, H defined in the context or config.

## 2. Coding Standards
* **Framework:** Use PyTorch.
* **Device Agnostic:** All tensors must be on the same `device` (handle `cuda` vs `cpu` explicitly).
* **Typing:** Always include Python type hints (e.g., `def forward(self, x: torch.Tensor) -> torch.Tensor:`).
* **Comments:** * File headers must describe the file's purpose.
    * Classes and functions must have docstrings explaining inputs/outputs.
    * Complex math blocks must cite the relevant Equation from `project_context.md`.

## 3. Testing & Verification
* **Mandatory Check:** Before marking a coding task as done, generate and run a small `assert` test script.
* **Shape Verification:** Specifically verify that tensor shapes match Equation (8) during forward passes.

## 4. Workflow & Context (The "Scratchpad" Rule)
* **Plan First:** Before starting any task, propose a plan in `scratchpad.md` and wait for user approval.
* **Track Progress:** After completing any sub-task, update `scratchpad.md` to reflect the new state. This file MUST act as the project's persistent progress bar and offline git log.
* **Status Updates:** Ensure the "Current Status" section of `scratchpad.md` is always accurate before ending a turn.

## 5. Hardware & Pipeline
* **Dual-Environment:** Code must run on both a Local Laptop (CPU/Weak GPU) and Kaggle (T4 x2).
* **The Toggle:** Implement a `config.py` with a simple toggle (e.g., `ENV = "LOCAL"` vs `ENV = "KAGGLE"`) that automatically adjusts batch sizes, dimensions, and paths.
* **Kaggle Pipeline:** When `ENV = "KAGGLE"`, the system should be prepared to bundle code for upload to Kaggle.

## 6. Modularity
* **Config-Driven:** Never hardcode hyperparameters. All "magic numbers" must live in `config.py`.
* **Swappable Components:** It should be possible to swap models (e.g., BDH vs GPT-2 Baseline) by changing one line in the config.

## 7. Directory Hygiene
* **Living Map:** Section 5 of `project_context.md` contains the Directory Structure.
* **Update Rule:** Whenever you create, delete, or move a file/folder, you **MUST** immediately update Section 5 of `project_context.md` to reflect the new state. This is not optional.

## 8. Environment Safety (MANDATORY)
* **Venv Enforcement:** Never run `python <script>` directly. You must always use the virtual environment executable to avoid dependency issues.
* **Command Pattern:** Use: `.\venv\Scripts\python.exe <script_name>`
* **Reason:** This ensures the GPU-enabled PyTorch version is always used, regardless of the terminal's activation state.

## 9. Bug Registry (MANDATORY)

* Maintain a `bugs.md` file as the single source of truth for all major or recurring bugs.
* For every non-trivial bug, add:
  * Error/symptoms, root cause, exact fix, and prevention note.
* Always consult `bugs.md` before debugging.
* When a fix is taken from `bugs.md`, explicitly reference that entry in your workflow.
